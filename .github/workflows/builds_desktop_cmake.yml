name: "Desktop CI builds (cmake)"
on:
  push:
    branches:
      - "**"
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:

env:
  APP_NAME: "9Launcher"
  APP_VERSION: "0.0.2"
  QT_VERSION: "6.8.2"

jobs:
  ## GNU/Linux build ###########################################################
  build-linux:
    name: "Linux CI build"
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository (and submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Enable apt repositories (act fix)
        if: ${{ env.ACT }}
        run: |
          sudo sed -i 's/^# deb/deb/' /etc/apt/sources.list
          sudo apt update

      - name: Install dependencies (from package manager)
        run: |
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkgconf \
            libgl-dev \
            libgles2-mesa-dev \
            libegl1-mesa-dev \
            libx11-dev \
            libx11-xcb-dev \
            libxext-dev \
            libxrender-dev \
            libxi-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libxcb1-dev \
            libwayland-dev \
            libwayland-client0 \
            libwayland-cursor0 \
            libwayland-egl1 \
            libwayland-server0 \
            libzstd-dev \
            libfuse2 \
            libtool \
            qt6-wayland \
            clang \
            clang-format

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{env.QT_VERSION}}
          modules: 'qtshadertools qtimageformats'
          install-deps: true
          dir: ${{ github.workspace }}/Qt

      - name: Build application
        run: |
            ./build.sh -DCMAKE_BUILD_TYPE=Release
            strip bin/9Launcher

      - name: Deploy application
        run: |
            ./deploy_linux.sh -i -c -p

      - name: Upload application ZIP
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.APP_NAME}}-${{env.APP_VERSION}}-linux64.tar.gz
          path: ${{env.APP_NAME}}-${{env.APP_VERSION}}-linux64.tar.gz

      # Upload AppImage
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.APP_NAME}}-${{env.APP_VERSION}}-linux64.AppImage
          path: ${{env.APP_NAME}}-${{env.APP_VERSION}}-linux64.AppImage

  # ## macOS build ###############################################################
  # build-mac:
  #   name: "macOS CI build"
  #   runs-on: macos-13
  #   steps:
  #     # Checkout repository (and submodules)
  #     - name: Checkout repository (and submodules)
  #       uses: actions/checkout@v4
  #       with:
  #         submodules: recursive
  #
  #     # Install dependencies (from package manager)
  #     #- name: Install dependencies (from package manager)
  #     #  run: |
  #     #       brew install qt6 cmake ninja
  #
  #     # Install Qt
  #     - name: Install Qt
  #       uses: jurplel/install-qt-action@v4
  #       with:
  #         version: ${{env.QT_VERSION}}
  #
  #     # Setup env
  #     - name: Setup env
  #       run: |
  #            cmake --version
  #
  #     # Build application
  #     - name: Build application
  #       run: |
  #            export CMAKE_BUILD_PARALLEL_LEVEL=`sysctl -n hw.logicalcpu`
  #            cmake -B build/ -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"
  #            cmake --build build/ --config Release
  #
  #     # Deploy application
  #     - name: Deploy application
  #       run: |
  #            ./deploy_macos.sh -c -p
  #
  #     # Upload application ZIP
  #     - name: Upload application ZIP
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: ${{env.APP_NAME}}-${{env.APP_VERSION}}-macOS.zip
  #         path: ${{env.APP_NAME}}-${{env.APP_VERSION}}-macOS.zip

  ## Windows build #############################################################
  build-windows:
    name: "Windows CI build"
    runs-on: windows-2022
    steps:
      # Checkout repository (and submodules)
      - name: Checkout repository (and submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86_64

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{env.QT_VERSION}}
          arch: 'win64_msvc2022_64'
          modules: 'qtshadertools qtimageformats'

      - name: Build application
        run: |
             cmake -B build/ -DCMAKE_BUILD_TYPE=Release -G Ninja
             cd build/
             ninja -j $env:NUMBER_OF_PROCESSORS

      - name: Deploy application
        run: |
             sh deploy_windows.sh -c -p

      - name: Upload application ZIP
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.APP_NAME}}-${{env.APP_VERSION}}-win64.zip
          path: ${{env.APP_NAME}}-${{env.APP_VERSION}}-win64.zip

      - name: Upload NSIS installer
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.APP_NAME}}-${{env.APP_VERSION}}-win64.exe
          path: ${{env.APP_NAME}}-${{env.APP_VERSION}}-win64.exe


  release:
    name: "Create GitHub Release"
    runs-on: ubuntu-latest

    needs:
      - build-linux
      - build-windows

    if: startsWith(github.ref, 'refs/tags/')

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "$GITHUB_REF_NAME" \
            --title "9Launcher $GITHUB_REF_NAME" \
            --generate-notes

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "$GITHUB_REF_NAME" artifacts/**/*
